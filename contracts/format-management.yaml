openapi: 3.0.3
info:
  title: 'Edge Cases & File Formats Management API'
  version: '1.0.0'
  description: 'API contracts for format detection, edge case handling, and format management in the Deduper application'

servers:
  - url: '/api/v1'
    description: 'Format Management API'

paths:
  /formats/detect:
    post:
      summary: 'Detect file format from file data'
      operationId: 'detectFormat'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: 'object'
              required: ['fileData', 'filename']
              properties:
                fileData:
                  type: 'string'
                  format: 'binary'
                  description: 'File data for format detection'
                filename:
                  type: 'string'
                  description: 'Original filename with extension'
                fileSize:
                  type: 'integer'
                  format: 'int64'
                  description: 'File size in bytes'
      responses:
        '200':
          description: 'Format detected successfully'
          content:
            application/json:
              schema:
                type: 'object'
                required: ['format', 'confidence', 'isSupported']
                properties:
                  format:
                    type: 'string'
                    description: 'Detected file format (e.g., "jpg", "mp4")'
                  confidence:
                    type: 'number'
                    format: 'float'
                    minimum: 0
                    maximum: 1
                    description: 'Detection confidence score'
                  isSupported:
                    type: 'boolean'
                    description: 'Whether the format is supported'
                  category:
                    type: 'string'
                    enum: ['image', 'video', 'audio', 'document', 'unknown']
                    description: 'Format category'
                  mimeType:
                    type: 'string'
                    description: 'MIME type of the file'
                  metadata:
                    type: 'object'
                    additionalProperties: true
                    description: 'Additional format-specific metadata'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /formats/batch-detect:
    post:
      summary: 'Detect formats for multiple files in batch'
      operationId: 'batchDetectFormats'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: 'object'
              required: ['files']
              properties:
                files:
                  type: 'array'
                  items:
                    type: 'object'
                    required: ['fileData', 'filename']
                    properties:
                      fileData:
                        type: 'string'
                        format: 'binary'
                      filename:
                        type: 'string'
                      fileSize:
                        type: 'integer'
                        format: 'int64'
                maxConcurrency:
                  type: 'integer'
                  minimum: 1
                  maximum: 50
                  default: 10
                  description: 'Maximum concurrent format detection operations'
      responses:
        '200':
          description: 'Batch format detection completed'
          content:
            application/json:
              schema:
                type: 'object'
                required: ['results', 'totalProcessed', 'successCount', 'errorCount']
                properties:
                  results:
                    type: 'array'
                    items:
                      type: 'object'
                      required: ['filename', 'format', 'confidence', 'isSupported', 'status']
                      properties:
                        filename:
                          type: 'string'
                        format:
                          type: 'string'
                        confidence:
                          type: 'number'
                          format: 'float'
                        isSupported:
                          type: 'boolean'
                        status:
                          type: 'string'
                          enum: ['success', 'error', 'unknown']
                        errorMessage:
                          type: 'string'
                        category:
                          type: 'string'
                  totalProcessed:
                    type: 'integer'
                    description: 'Total files processed'
                  successCount:
                    type: 'integer'
                    description: 'Number of successfully processed files'
                  errorCount:
                    type: 'integer'
                    description: 'Number of files with errors'
                  processingTimeMs:
                    type: 'number'
                    format: 'float'
                    description: 'Total processing time in milliseconds'
                  averageProcessingTimeMs:
                    type: 'number'
                    format: 'float'
                    description: 'Average processing time per file'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /formats/edge-cases/detect:
    post:
      summary: 'Detect edge cases in file processing'
      operationId: 'detectEdgeCases'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: 'object'
              required: ['filename', 'fileSize', 'format']
              properties:
                filename:
                  type: 'string'
                  description: 'File name including path'
                fileSize:
                  type: 'integer'
                  format: 'int64'
                  description: 'File size in bytes'
                format:
                  type: 'string'
                  description: 'Detected file format'
                fileData:
                  type: 'string'
                  format: 'binary'
                  description: 'Optional file data for analysis'
                checkTypes:
                  type: 'array'
                  items:
                    type: 'string'
                    enum: ['corruption', 'zero_byte', 'hidden_file', 'system_file', 'large_file', 'unusual_format']
                  default: ['corruption', 'zero_byte']
                  description: 'Types of edge cases to check'
      responses:
        '200':
          description: 'Edge case detection completed'
          content:
            application/json:
              schema:
                type: 'object'
                required: ['edgeCases', 'canProcess', 'recommendations']
                properties:
                  edgeCases:
                    type: 'array'
                    items:
                      $ref: '#/components/schemas/EdgeCase'
                    description: 'Detected edge cases'
                  canProcess:
                    type: 'boolean'
                    description: 'Whether the file can be processed safely'
                  recommendations:
                    type: 'array'
                    items:
                      type: 'string'
                    description: 'Recommended actions for handling edge cases'
                  processingStrategy:
                    type: 'string'
                    enum: ['normal', 'skip', 'repair', 'manual_review', 'error']
                    description: 'Recommended processing strategy'
                  confidence:
                    type: 'number'
                    format: 'float'
                    minimum: 0
                    maximum: 1
                    description: 'Confidence in edge case detection'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /formats/edge-cases/batch-detect:
    post:
      summary: 'Detect edge cases for multiple files in batch'
      operationId: 'batchDetectEdgeCases'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: 'object'
              required: ['files']
              properties:
                files:
                  type: 'array'
                  items:
                    type: 'object'
                    required: ['filename', 'fileSize', 'format']
                    properties:
                      filename:
                        type: 'string'
                      fileSize:
                        type: 'integer'
                        format: 'int64'
                      format:
                        type: 'string'
                      fileData:
                        type: 'string'
                        format: 'binary'
                checkTypes:
                  type: 'array'
                  items:
                    type: 'string'
                    enum: ['corruption', 'zero_byte', 'hidden_file', 'system_file', 'large_file', 'unusual_format']
                  default: ['corruption', 'zero_byte']
                maxConcurrency:
                  type: 'integer'
                  minimum: 1
                  maximum: 50
                  default: 10
      responses:
        '200':
          description: 'Batch edge case detection completed'
          content:
            application/json:
              schema:
                type: 'object'
                required: ['results', 'totalProcessed', 'edgeCaseCount', 'processableCount']
                properties:
                  results:
                    type: 'array'
                    items:
                      type: 'object'
                      required: ['filename', 'edgeCases', 'canProcess', 'processingStrategy']
                      properties:
                        filename:
                          type: 'string'
                        edgeCases:
                          type: 'array'
                          items:
                            $ref: '#/components/schemas/EdgeCase'
                        canProcess:
                          type: 'boolean'
                        processingStrategy:
                          type: 'string'
                        recommendations:
                          type: 'array'
                          items:
                            type: 'string'
                  totalProcessed:
                    type: 'integer'
                    description: 'Total files processed'
                  edgeCaseCount:
                    type: 'integer'
                    description: 'Number of files with detected edge cases'
                  processableCount:
                    type: 'integer'
                    description: 'Number of files that can be processed'
                  processingTimeMs:
                    type: 'number'
                    format: 'float'
                    description: 'Total processing time in milliseconds'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /formats/configuration:
    get:
      summary: 'Get current format configuration'
      operationId: 'getFormatConfiguration'
      responses:
        '200':
          description: 'Current format configuration'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FormatConfiguration'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      summary: 'Update format configuration'
      operationId: 'updateFormatConfiguration'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FormatConfiguration'
      responses:
        '200':
          description: 'Configuration updated successfully'
          content:
            application/json:
              schema:
                type: 'object'
                required: ['success', 'updatedAt']
                properties:
                  success:
                    type: 'boolean'
                  updatedAt:
                    type: 'string'
                    format: 'date-time'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /formats/statistics:
    get:
      summary: 'Get format processing statistics'
      operationId: 'getFormatStatistics'
      parameters:
        - name: 'timeRange'
          in: 'query'
          schema:
            type: 'string'
            enum: ['hour', 'day', 'week', 'month']
            default: 'day'
            description: 'Time range for statistics'
        - name: 'formatCategory'
          in: 'query'
          schema:
            type: 'string'
            enum: ['image', 'video', 'audio', 'document', 'all']
            default: 'all'
            description: 'Filter statistics by format category'
      responses:
        '200':
          description: 'Format processing statistics'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FormatStatistics'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /formats/test-detection:
    post:
      summary: 'Test format detection with sample files'
      operationId: 'testFormatDetection'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: 'object'
              properties:
                testFormats:
                  type: 'array'
                  items:
                    type: 'string'
                  default: ['jpg', 'png', 'mp4', 'pdf', 'mp3']
                  description: 'Formats to test (defaults to common formats)'
                createTestFiles:
                  type: 'boolean'
                  default: true
                  description: 'Whether to create test files'
      responses:
        '200':
          description: 'Format detection test completed'
          content:
            application/json:
              schema:
                type: 'object'
                required: ['results', 'testSummary', 'accuracy', 'errors']
                properties:
                  results:
                    type: 'array'
                    items:
                      type: 'object'
                      required: ['format', 'detected', 'confidence', 'success']
                      properties:
                        format:
                          type: 'string'
                        detected:
                          type: 'boolean'
                        confidence:
                          type: 'number'
                          format: 'float'
                        success:
                          type: 'boolean'
                        errorMessage:
                          type: 'string'
                  testSummary:
                    type: 'string'
                    description: 'Human-readable test summary'
                  accuracy:
                    type: 'number'
                    format: 'float'
                    minimum: 0
                    maximum: 1
                    description: 'Overall detection accuracy'
                  errors:
                    type: 'array'
                    items:
                      type: 'string'
                    description: 'Any errors encountered during testing'
                  processingTimeMs:
                    type: 'number'
                    format: 'float'
                    description: 'Total test processing time'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  schemas:
    EdgeCase:
      type: 'object'
      required: ['type', 'severity', 'description', 'detectedAt']
      properties:
        type:
          type: 'string'
          enum: ['corruption', 'zero_byte', 'hidden_file', 'system_file', 'large_file', 'unusual_format', 'permission_error']
          description: 'Type of edge case detected'
        severity:
          type: 'string'
          enum: ['low', 'medium', 'high', 'critical']
          description: 'Severity level of the edge case'
        description:
          type: 'string'
          description: 'Human-readable description of the edge case'
        confidence:
          type: 'number'
          format: 'float'
          minimum: 0
          maximum: 1
          description: 'Confidence in edge case detection'
        detectedAt:
          type: 'string'
          format: 'date-time'
          description: 'When the edge case was detected'
        metadata:
          type: 'object'
          additionalProperties: true
          description: 'Additional metadata about the edge case'
        recommendedAction:
          type: 'string'
          enum: ['skip', 'repair', 'manual_review', 'process_normally', 'error']
          description: 'Recommended action for handling this edge case'

    FormatConfiguration:
      type: 'object'
      properties:
        supportedFormats:
          type: 'object'
          properties:
            imageFormats:
              type: 'array'
              items:
                type: 'string'
            videoFormats:
              type: 'array'
              items:
                type: 'string'
            audioFormats:
              type: 'array'
              items:
                type: 'string'
            documentFormats:
              type: 'array'
              items:
                type: 'string'
        processingOptions:
          type: 'object'
          properties:
            enableImageProcessing:
              type: 'boolean'
            enableVideoProcessing:
              type: 'boolean'
            enableAudioProcessing:
              type: 'boolean'
            enableDocumentProcessing:
              type: 'boolean'
        edgeCaseHandling:
          type: 'object'
          properties:
            handleCorruptedFiles:
              type: 'boolean'
            skipZeroByteFiles:
              type: 'boolean'
            processHiddenFiles:
              type: 'boolean'
            processSystemFiles:
              type: 'boolean'
        qualityThresholds:
          type: 'object'
          properties:
            imageQualityThreshold:
              type: 'number'
              format: 'float'
              minimum: 0.1
              maximum: 1.0
            videoQualityThreshold:
              type: 'number'
              format: 'float'
              minimum: 0.1
              maximum: 1.0
            audioQualityThreshold:
              type: 'number'
              format: 'float'
              minimum: 0.1
              maximum: 1.0
            documentQualityThreshold:
              type: 'number'
              format: 'float'
              minimum: 0.1
              maximum: 1.0
        advancedOptions:
          type: 'object'
          properties:
            enableDeepInspection:
              type: 'boolean'
            enableMetadataExtraction:
              type: 'boolean'
            enableThumbnailGeneration:
              type: 'boolean'
            batchProcessingLimit:
              type: 'integer'
              minimum: 100
              maximum: 5000
        updatedAt:
          type: 'string'
          format: 'date-time'

    FormatStatistics:
      type: 'object'
      required: ['timestamp', 'timeRange', 'totalFiles', 'processedFiles', 'errorCount']
      properties:
        timestamp:
          type: 'string'
          format: 'date-time'
          description: 'When statistics were generated'
        timeRange:
          type: 'string'
          enum: ['hour', 'day', 'week', 'month']
          description: 'Time range covered by statistics'
        totalFiles:
          type: 'integer'
          description: 'Total files processed'
        processedFiles:
          type: 'integer'
          description: 'Successfully processed files'
        errorCount:
          type: 'integer'
          description: 'Files with processing errors'
        formatBreakdown:
          type: 'object'
          additionalProperties:
            type: 'integer'
          description: 'File count by format type'
        edgeCaseBreakdown:
          type: 'object'
          additionalProperties:
            type: 'integer'
          description: 'Edge case count by type'
        performanceMetrics:
          type: 'object'
          properties:
            averageProcessingTimeMs:
              type: 'number'
              format: 'float'
            averageDetectionTimeMs:
              type: 'number'
              format: 'float'
            detectionAccuracy:
              type: 'number'
              format: 'float'
            throughputFilesPerMinute:
              type: 'number'
              format: 'float'
        qualityMetrics:
          type: 'object'
          properties:
            qualityScoreDistribution:
              type: 'object'
              additionalProperties:
                type: 'integer'
            rejectedFilesByThreshold:
              type: 'integer'
            averageQualityScore:
              type: 'number'
              format: 'float'

  responses:
    BadRequest:
      description: 'Bad request'
      content:
        application/json:
          schema:
            type: 'object'
            required: ['error', 'code']
            properties:
              error:
                type: 'string'
              code:
                type: 'string'
              details:
                type: 'object'

    InternalServerError:
      description: 'Internal server error'
      content:
        application/json:
          schema:
            type: 'object'
            required: ['error', 'code']
            properties:
              error:
                type: 'string'
              code:
                type: 'string'
