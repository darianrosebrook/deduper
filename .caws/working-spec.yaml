id: MERGE-001
title: 'Safe file merging for duplicate groups'
mode: feature
risk_tier: 1
blast_radius:
  modules:
    - 'DeduperCore/FileOperations'
    - 'DeduperCore/MergeTransaction'
    - 'DeduperUI/MergePreview'
    - 'DeduperUI/MergeConfirmation'
  data_migration: false
  external_apis: false
operational_rollback_slo: 5m
change_budget:
  max_files: 25
  max_loc: 1000
  max_days: 3
scope:
  in:
    - 'Move duplicate files to trash while preserving selected keeper'
    - 'Create merge transaction records for undo support'
    - 'Update file system with safe operations'
    - 'Provide detailed merge preview before execution'
  out:
    - 'Database-only operations'
    - 'Cloud file operations'
    - 'System file restoration'
invariants:
  - 'Keeper file must exist and be accessible'
  - 'All duplicate files must be verified before deletion'
  - 'Merge transactions must be atomic and recoverable'
  - 'No file operations without user confirmation'
  - 'File system operations must be reversible'
acceptance:
  - id: A1
    given: 'user selects keeper file in duplicate group'
    when: 'user initiates merge operation'
    then: 'show detailed merge preview with before/after states'
  - id: A2
    given: 'user confirms merge in preview'
    when: 'merge operation executes'
    then: 'keeper file preserved, duplicates moved to trash, transaction recorded'
  - id: A3
    given: 'user requests undo within time window'
    when: 'undo operation executes'
    then: 'files restored from trash, merge transaction marked as undone'
  - id: A4
    given: 'merge operation encounters error'
    when: 'error occurs during file operation'
    then: 'partial operations rolled back, user notified, transaction marked failed'
non_functional:
  a11y:
    - 'keyboard navigation for all merge controls'
    - 'screen reader announcements for operation status'
    - 'focus management during confirmation dialogs'
  perf:
    api_p95_ms: 500
    lcp_ms: 100
  security:
    - 'no file operations without explicit user consent'
    - 'secure trash operations with verification'
    - 'atomic transactions with rollback capability'
contracts:
  - type: openapi
    path: 'contracts/merge-operations.yaml'
observability:
  logs:
    - 'merge operation start/end with file counts'
    - 'file operation results (success/failure per file)'
    - 'undo operation attempts and results'
  metrics:
    - 'merge_success_count'
    - 'merge_failure_count'
    - 'files_processed_per_merge'
    - 'undo_success_rate'
  traces:
    - 'merge_operation span with group_id, keeper_id, file_count'
    - 'file_operation spans with file paths and results'
migrations:
  - 'add MergeTransaction entity with file references and undo metadata'
  - 'add merge history tracking to DuplicateGroup'
  - 'add file operation status tracking'
rollback:
  - 'feature flag MERGE_OPERATIONS=false to disable UI'
  - 'automatic rollback of failed merge operations'
  - 'manual undo via transaction records'
